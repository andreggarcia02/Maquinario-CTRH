<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard de Equipamentos</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Plugin para mostrar valores nos gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <!-- SheetJS para ler o .xlsx do Google Sheets -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#f3f4f6;
      margin:0;
      padding:0;
      color:#111827;
    }
    header {
      background:#111827;
      color:#f9fafb;
      padding:16px 32px;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
    }
    header h1 {
      margin:0;
      font-size:22px;
      font-weight:600;
    }
    header .subtitle {
      margin-top:4px;
      font-size:12px;
      color:#9ca3af;
    }
    .container {
      padding:20px 32px 32px 32px;
    }
    .kpi-row {
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      margin-bottom:24px;
    }
    .kpi-card {
      background:#ffffff;
      border-radius:10px;
      padding:12px 16px;
      box-shadow:0 1px 4px rgba(15,23,42,0.15);
      min-width:200px;
      flex:1;
    }
    .kpi-label {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:#6b7280;
      margin-bottom:4px;
    }
    .kpi-value {
      font-size:20px;
      font-weight:600;
    }
    .kpi-note {
      margin-top:2px;
      font-size:11px;
      color:#9ca3af;
    }
    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
      gap:20px;
    }
    .panel {
      background:#ffffff;
      border-radius:10px;
      padding:14px 18px;
      box-shadow:0 1px 4px rgba(15,23,42,0.10);
    }
    .panel h2 {
      margin:0 0 4px 0;
      font-size:16px;
      font-weight:600;
    }
    .panel p.desc {
      margin:0 0 10px 0;
      font-size:12px;
      color:#6b7280;
    }
    canvas {
      width:100% !important;
      height:260px !important;
    }
    .loading {
      font-size:13px;
      color:#6b7280;
      margin-bottom:16px;
    }
    footer {
      margin-top:20px;
      border-top:1px solid #e5e7eb;
      padding:10px 32px;
      font-size:11px;
      color:#9ca3af;
      background:#f9fafb;
      text-align:center;
    }
  </style>
</head>
<body>

<header>
  <h1>Painel de Equipamentos</h1>
  <div class="subtitle">
    Horas, custo e situação da frota alimentados automaticamente a partir de uma planilha do Google Sheets.
  </div>
</header>

<div class="container">
  <div id="loading" class="loading">
    Carregando dados do Google Sheets...
  </div>

  <div class="kpi-row">
    <div class="kpi-card">
      <div class="kpi-label">Data da última atualização</div>
      <div class="kpi-value" id="kpi-last-date">-</div>
      <div class="kpi-note">Última data lançada na aba LANCAMENTOS.</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Operadores com lançamento</div>
      <div class="kpi-value" id="kpi-op-count">-</div>
      <div class="kpi-note">Operadores com horas registradas.</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Equipamentos com uso registrado</div>
      <div class="kpi-value" id="kpi-eq-used">-</div>
      <div class="kpi-note">Máquinas que têm pelo menos uma hora lançada.</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Grupos com custo lançado</div>
      <div class="kpi-value" id="kpi-grp-cost">-</div>
      <div class="kpi-note">Centros de custo com valor na aba CUSTO POR GRUPO.</div>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <h2>Horas trabalhadas por operador</h2>
      <p class="desc">Distribuição das horas lançadas por operador.</p>
      <canvas id="opChart"></canvas>
    </div>

    <div class="panel">
      <h2>Horas trabalhadas por equipamento</h2>
      <p class="desc">Ajuda a identificar máquinas mais utilizadas e aquelas ociosas.</p>
      <canvas id="eqChart"></canvas>
    </div>

    <div class="panel">
      <h2>Horas por grupo</h2>
      <p class="desc">Horas acumuladas por grupo/centro de custo.</p>
      <canvas id="grpHoursChart"></canvas>
    </div>

    <div class="panel">
      <h2>Custo por grupo</h2>
      <p class="desc">Valores consolidados a partir da aba “CUSTO POR GRUPO”.</p>
      <canvas id="grpCostChart"></canvas>
    </div>

    <div class="panel">
      <h2>Custo hora por equipamento</h2>
      <p class="desc">Custo hora informado na aba EQUIPAMENTOS.</p>
      <canvas id="costChart"></canvas>
    </div>

    <div class="panel">
      <h2>Situação dos equipamentos</h2>
      <p class="desc">Quantidade de máquinas ativas e em manutenção.</p>
      <canvas id="situChart"></canvas>
    </div>
  </div>
</div>

<footer>
  Dashboard gerado automaticamente a partir da planilha pública do Google Sheets (formato .xlsx).
</footer>

<script>
  const EXCEL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3RTMFeAPMzNQ8AJ8emFLMWaULlnZLEGlv57VvMnkk1-2LeredVXq5JSie7WaI70Dmy36ZQMjJXvbC/pub?output=xlsx";

  // -------- Helpers --------
  function toNumber(v) {
    if (v === null || v === undefined || v === "") return NaN;

    // Já é número
    if (typeof v === "number") {
      return isFinite(v) ? v : NaN;
    }

    // String com vírgula ou ponto
    if (typeof v === "string") {
      const trimmed = v.trim();
      if (!trimmed) return NaN;

      // remove separador de milhar e troca vírgula por ponto
      const clean = trimmed.replace(/\./g, "").replace(",", ".");
      const n = parseFloat(clean);
      return isFinite(n) ? n : NaN;
    }

    const n = Number(v);
    return isFinite(n) ? n : NaN;
  }

  function parseDate(d) {
    if (!d) return null;
    if (d instanceof Date && !isNaN(d)) return d;

    if (typeof d === "string") {
      const dt = new Date(d);
      return isNaN(dt) ? null : dt;
    }

    if (typeof d === "number") {
      // Excel serial date (dias desde 1899-12-30)
      const epoch = new Date(Date.UTC(1899, 11, 30));
      const ms = d * 24*60*60*1000;
      const dt = new Date(epoch.getTime() + ms);
      return isNaN(dt) ? null : dt;
    }
    return null;
  }

  function formatDateBr(d) {
    if (!d || isNaN(d)) return "-";
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  function groupSum(rows, keyField, valueField) {
    const map = new Map();
    for (const r of rows) {
      const k = String(r[keyField] ?? "").trim() || "(sem)";
      const v = toNumber(r[valueField]);
      if (isNaN(v)) continue; // ignora valores não numéricos
      if (!map.has(k)) map.set(k, 0);
      map.set(k, map.get(k) + v);
    }
    return Array.from(map.entries()).map(([label, value]) => ({ label, value }));
  }

  function makeBar(id, labels, data, valuePrefix = "") {
    const ctx = document.getElementById(id);
    if (!ctx || !labels.length) return;
    new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{ data }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: "end",
            align: "end",
            formatter: (value) =>
              valuePrefix ? valuePrefix + value.toFixed(2) : value.toFixed(2),
            font: { size: 10 }
          }
        },
        scales: {
          x: {
            ticks: { autoSkip: true, maxRotation: 45, minRotation: 0 }
          },
          y: {
            beginAtZero: true
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  function makePie(id, labels, data) {
    const ctx = document.getElementById(id);
    if (!ctx || !labels.length) return;
    new Chart(ctx, {
      type: "pie",
      data: {
        labels,
        datasets: [{ data }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          datalabels: {
            formatter: (value, ctx) => {
              const total = ctx.chart.data.datasets[0].data
                .reduce((a, b) => a + b, 0);
              if (!total) return "";
              const pct = (value / total * 100).toFixed(1);
              return pct + "%";
            },
            font: { size: 10 }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  async function loadData() {
    const loadingEl = document.getElementById("loading");
    try {
      const resp = await fetch(EXCEL_URL);
      if (!resp.ok) throw new Error("Erro ao baixar planilha");
      const buf = await resp.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });

      const lancSheet = wb.Sheets["LANCAMENTOS"];
      const equipSheet = wb.Sheets["EQUIPAMENTOS"];
      const grpSheet = wb.Sheets["CUSTO POR GRUPO"];

      if (!lancSheet || !equipSheet || !grpSheet) {
        loadingEl.textContent = "Erro: uma das abas esperadas (LANCAMENTOS, EQUIPAMENTOS, CUSTO POR GRUPO) não foi encontrada.";
        return;
      }

      const lanc = XLSX.utils.sheet_to_json(lancSheet, { defval: null });
      const equip = XLSX.utils.sheet_to_json(equipSheet, { defval: null });
      const grp = XLSX.utils.sheet_to_json(grpSheet, { defval: null });

      // --- Lançamentos ---
      let lastDate = null;
      for (const r of lanc) {
        const d = parseDate(r["Data"]);
        if (d && (!lastDate || d > lastDate)) lastDate = d;
      }

      // Horas calculadas
      for (const r of lanc) {
        let h = toNumber(r["Horas trabalhadas"]);
        if (!h && r["Horímetro inicial"] != null && r["Horímetro final"] != null) {
          h = toNumber(r["Horímetro final"]) - toNumber(r["Horímetro inicial"]);
        }
        r._Horas_calc = h;
      }

      // Horas por operador / equipamento / grupo
      const opAgg = groupSum(lanc, "Operador", "_Horas_calc");
      const eqAgg = groupSum(lanc, "Equipamento", "_Horas_calc");
      const grpHoursAgg = groupSum(lanc, "Grupo", "_Horas_calc");

      const opLabels = opAgg.map(x => x.label);
      const opValues = opAgg.map(x => x.value);

      const eqLabels = eqAgg.map(x => x.label);
      const eqValues = eqAgg.map(x => x.value);

      const grpHLabels = grpHoursAgg.map(x => x.label);
      const grpHValues = grpHoursAgg.map(x => x.value);

      // --- Equipamentos: custo hora e situação ---
      const costLabels = [];
      const costValues = [];
      const situMap = new Map();

      for (const r of equip) {
        const nome = String(r["Nome"] ?? "").trim();
        if (nome) {
          const rawCost =
            r["Custo hora (R$)"] ??
            r["Custo hora máquina (R$)"] ??
            r["Custo hora maquina (R$)"];
          const c = toNumber(rawCost);
          if (!isNaN(c)) {
            costLabels.push(nome);
            costValues.push(c);
          }
        }

        const sit = String(r["Situação (Ativo/Manutenção)"] ?? "").trim() || "(sem)";
        if (!situMap.has(sit)) situMap.set(sit, 0);
        situMap.set(sit, situMap.get(sit) + 1);
      }

      const situLabels = Array.from(situMap.keys());
      const situValues = Array.from(situMap.values());

      // --- Custo por grupo (aba CUSTO POR GRUPO) ---
      const grpCostLabels = [];
      const grpCostValues = [];
      for (const r of grp) {
        const g = String(r["GRUPO"] ?? "").trim();
        const c = toNumber(r["CUSTO"]);
        if (g && !isNaN(c)) {
          grpCostLabels.push(g);
          grpCostValues.push(c);
        }
      }

      // --- KPIs ---
      const lastDateStr = formatDateBr(lastDate);
      const opWithHours = opAgg.filter(x => x.value > 0).length;
      const eqWithHours = eqAgg.filter(x => x.value > 0).length;
      const grpWithCost = grpCostValues.filter(v => v > 0).length;

      document.getElementById("kpi-last-date").textContent = lastDateStr;
      document.getElementById("kpi-op-count").textContent = opWithHours;
      document.getElementById("kpi-eq-used").textContent = eqWithHours;
      document.getElementById("kpi-grp-cost").textContent = grpWithCost;

      // --- Gráficos ---
      makeBar("opChart", opLabels, opValues);
      makeBar("eqChart", eqLabels, eqValues);
      makeBar("grpHoursChart", grpHLabels, grpHValues);
      makeBar("grpCostChart", grpCostLabels, grpCostValues, "R$ ");
      makeBar("costChart", costLabels, costValues, "R$ ");
      makePie("situChart", situLabels, situValues);

      loadingEl.textContent = "";
    } catch (err) {
      console.error(err);
      const loadingEl = document.getElementById("loading");
      loadingEl.textContent = "Erro ao carregar ou processar os dados da planilha.";
    }
  }

  document.addEventListener("DOMContentLoaded", loadData);
</script>

</body>
</html>
